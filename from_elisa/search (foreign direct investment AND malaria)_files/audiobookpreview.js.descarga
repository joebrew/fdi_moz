(function(a){a.widget("ui.audiobookpreview",{options:{type:{}},_an:{},_audioUrl:{},_audioElement:{},_playButton:{},_progressBar:{},_isPlaying:false,_create:function(){ep.debug("audiobookpreview:create");var c=this;this._an=a(this.element).data("an");this._playButton=a(this.element).find(".audio-sample");this._progressBar=a(this.element).find(".progress-indicator");this._audioUrl=a(this.element).data("src");if(this.options.type==="html5"){this._audioElement=a("<audio/>").attr("src",this._audioUrl)[0];}else{this._audioElement=swfobject.getObjectById("flashReplacement");try{this._audioElement.initFlash(this._audioUrl);}catch(b){c.destroy();}}a(document).bind("playAudio",function(d,e){if(e!==c._an&&c._audioElement){if(c.options.type==="html5"){c._stop();}else{c._playButton.removeClass("playing");c._progressBar.css({width:"0%"});}c.destroy();}});},_init:function(){ep.debug("audiobookpreview:init");if(this._audioElement){if(!this._isPlaying){a(document).trigger("playAudio",this._an);this._play();}else{this._pause();}}else{this.destroy();}},_play:function(){ep.debug("audiobookpreview:playing");if(this.options.type==="html5"){this._audioElement.play();}else{this._audioElement.playFlash();}this._isPlaying=true;this._playButton.addClass("playing");this._timeUpdate();},_pause:function(){ep.debug("audiobookpreview:paused");if(this.options.type==="html5"){this._audioElement.pause();}else{this._audioElement.pauseFlash();}this._isPlaying=false;this._playButton.removeClass("playing");},_stop:function(){this._pause();ep.debug("audiobookpreview:stopped");if(this.options.type==="html5"){this._audioElement.currentTime=0;}else{this._audioElement.stopFlash();}this._progressBar.css({width:"0%"});},_timeUpdate:function(){if(this._isPlaying){var b,f;var d=false;if(this.options.type==="html5"){b=this._audioElement.duration;f=this._audioElement.currentTime;if(f>0&&f>=(b-0.1)){d=true;}}else{b=this._audioElement.durationFlash();f=this._audioElement.currentTimeFlash();if(this._audioElement.isEndedFlash()){d=true;}}var c=f/b;var e=c*100;this._progressBar.css({width:e+"%"});if(d){this._stop();}this._timer=setTimeout(a.proxy(this._timeUpdate,this),500);}else{clearTimeout(this._timer);}},destroy:function(){ep.debug("audiobookpreview:destory");a.Widget.prototype.destroy.call(this);}});a(function(){var b;if(Modernizr.audio&&Modernizr.audio.mp3){b="html5";}else{b="flash";a("body").append("<span id='flashReplacement'/>");swfobject.embedSWF(ep.baseImagePath+"flash/audiobookpreview.swf","flashReplacement","0","0","9.0.0","",{},{allowScriptAccess:"always"});}a(document).delegate(".audio-sample","click",function(c){a(this).parent().audiobookpreview({type:b});c.preventDefault();});});})(jQuery);